<?php
if(!isset($_POST['submit']))
{
//This page should not be accessed directly. Need to submit the form.
echo "error; You need to submit the form!";
}
$firstname = $_POST['firstname'];
$lastname = $_POST['lastname'];
$email = $_POST['email'];
$activity = $_POST['activity'];

//Validate first
if(empty($firstname)||empty($lastname)||empty($email)) 
{
echo " First name, Last name and email are required for the form! Please fill them out.";
exit;
}

if(IsInjected($email))
{
echo "Bad email value!";
exit;
}

$email_from = 'nkemakwari@aol.com';
$email_subject = "New Website Form submission";
$email_body = "You have received a new message from the user $firstname $lastname.\n".
"Their insterest is:\n $activity\r\n".

$to = "nkemakwari@aol.com";
$headers = "From: $email_from \r\n";
$headers .= "Reply-To: $email \r\n";

//Send the email!
mail($to,$email_subject,$email_body,$headers);
//done. redirect to thank-you page.
header('Location: Thank You.html');



$list = array
(
"FirstName,LastName,Email,Activity",
);

$file = fopen("enquiries.csv","w");

foreach ($list as $line)
{
fputcsv($file,explode(',',$line));
}

fclose($file); 


// Retrieve filename from form
$filename = $_POST['filename'];

// work through each form field
foreach($_POST as $name => $value)
{

// ignore form field if it is Submit or the filename
IF ($value != "Submit" and $value !=$filename)
{
// Add form field to the message to be displayed and a line break
$messagedisplay = $messagedisplay . $name. ": " . $value . "<BR>";
// Add form field to the file to be saved and a comma for CSV files
$filedata = $filedata . $value . ",";
}
}

// remove the last comma from the data to be saved
$filedata = rtrim($filedata,",");
// add an end of line character to the data to be saved
$filedata = $filedata . PHP_EOL;
// open the filename with the filename specified in the form
$fs = fopen($filename,a);
// write to the file the file data
fwrite($fs,$filedata);
// close the file
fclose($fs);

// Add the introductory information to the message to display
$messagedisplay = "<center><b>Thank you</b><br>Your enquiry has been sent with the following information:<BR><BR>" . $messagedisplay . "<BR><BR>and has been saved to " . $filename;

//print the confirmation screen
print $messagedisplay;


// Function to validate against any email injection attempts
function IsInjected($str)
{
$injections = array('(\n+)',
'(\r+)',
'(\t+)',
'(%0A+)',
'(%0D+)',
'(%08+)',
'(%09+)'
);
$inject = join('|', $injections);
$inject = "/$inject/i";
if(preg_match($inject,$str))
{
return true;
}
else
{
return false;
}
}

?>